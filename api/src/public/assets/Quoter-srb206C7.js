import{r as c,j as e,S as B,O as Y,a as J,p as H}from"./index-DUTae07C.js";import{N as F,B as g,I as v,s as N,T as V}from"./method-http.utility-DTRIZLiH.js";import{E as Z,D as A,K as I,a as K,T as ee}from"./index-BabMYYNb.js";import{S as te}from"./Search-BFt35SwB.js";import{c as C,g as ae}from"./format.utility-D1koD93K.js";import{h as se}from"./customer.service-BXoTG7B1.js";import{M as D}from"./Utilityes.d-EXBqBskY.js";import{h as oe}from"./aution.service-Bh9Hnird.js";import{h as re}from"./crane.service-BJRE_J8B.js";import{h as le}from"./port.service-BLEbI90D.js";import{h as ie}from"./type-vehicle.service-D577OHjz.js";import{M as L,S as O,L as ne,F as ce}from"./Table-DFuZ754j.js";import{F as h}from"./index-ClDAYrEx.js";import{I as U}from"./index-DmcKSry_.js";import{T as de}from"./index-Dlzl8EP_.js";import"./Private-XhUdaezg.js";const ue=(o,i)=>{const y=window.URL.createObjectURL(new Blob([o])),j=document.createElement("a");j.href=y,j.setAttribute("download",i),document.body.appendChild(j),j.click()},R="/quoter",me=async o=>await F({path:`${R}/${o}`,method:"GET"}),pe=async o=>await F({path:R,method:"POST",data:o}),W=async o=>await F({path:`${R}/${o.id_cotizacion}`,method:"PUT",data:o}),he=async o=>await F({path:`${R}/invoice/${o}`,method:"GET",responseType:"blob"}),xe=async o=>await F({path:`${R}/pagination`,method:"POST",data:o}),X=o=>{var i,y,j,z,T,b,x;return{...o,id_cliente:(i=o.cliente)==null?void 0:i.id_cliente,id_vendedor:(y=o.vendedor)==null?void 0:y.id_usuario,id_tipo_vehiculo:(j=o.tipo_veniculo)==null?void 0:j.id_tipo_vehiculo,id_puerto:(z=o.puerto)==null?void 0:z.id_puerto,id_subasta:(T=o.subasta)==null?void 0:T.id_subasta,id_grua_usd:(b=o.grua_usd)==null?void 0:b.id_grua,id_grua_gt:(x=o.grua_gt)==null?void 0:x.id_g}},fe=({aprobado:o,details:i,onSubmit:y})=>{const[j,z]=c.useState(Z),[T,b]=c.useState(!1),x=async l=>{const S=[...i];S.push({...l,valor:C(l.valor??"")}),y(S),b(!1)},k=l=>e.jsx(e.Fragment,{children:l.map((S,f)=>e.jsxs("div",{className:"flex flex-row justify-between gap-3 items-center",children:[e.jsxs("strong",{className:"flex-1",children:[S.nombre,": "]}),e.jsx("span",{children:S.moneda}),e.jsx("span",{children:C(S.valor??0)}),e.jsxs("div",{children:[e.jsx(g,{type:"link",htmlType:"button",size:"small",icon:e.jsx(v.Edit,{}),disabled:o,onClick:()=>{z({...S,index:f}),b(!0)}}),e.jsx(g,{danger:!0,type:"link",size:"small",htmlType:"button",icon:e.jsx(v.Trash,{}),disabled:o,onClick:()=>{const P=i.filter(G=>G.moneda!==S.moneda),w=l.filter((G,u)=>u!==f);y([...P,...w])}})]})]},f))});return e.jsxs(e.Fragment,{children:[i.some(l=>l.moneda===D.USD)&&e.jsx(A,{orientation:"left",children:"Costos USD"}),k(i.filter(l=>l.moneda===D.USD)),i.some(l=>l.moneda===D.GTQ)&&e.jsx(A,{orientation:"left",children:"Costos GTQ"}),k(i.filter(l=>l.moneda===D.GTQ)),e.jsx("div",{className:"text-right mt-3",children:e.jsx(g,{type:"primary",style:{color:B.secondary,borderColor:B.secondary},ghost:!0,size:"small",htmlType:"button",icon:e.jsx(v.Plus,{}),onClick:()=>b(!0),children:"Agregar"})}),e.jsx(L,{open:T,onCancel:()=>b(!1),footer:null,title:"Editar",destroyOnClose:!0,children:e.jsxs(h,{layout:"vertical",initialValues:j,onFinish:x,children:[e.jsx(h.Item,{label:"Titulo",name:"nombre",rules:[{required:!0,message:"El campo es requerido"}],children:e.jsx(U,{placeholder:"Ingrese un titulo"})}),e.jsx(h.Item,{label:"Moneda",name:"moneda",rules:[{required:!0,message:"El campo es requerido"}],children:e.jsx(O,{allowClear:!0,className:"w-100",placeholder:"Selecciones una opción",options:Object.keys(D).map(l=>({label:l,value:D[l]}))})}),e.jsx(h.Item,{label:"Valor",name:"valor",rules:[{required:!0,message:"El campo es requerido"}],children:e.jsx(de,{placeholder:"Ingrese un valor",className:"w-100",formatter:l=>C(l??"")})}),e.jsx("div",{className:"text-right mt-3",children:e.jsx(g,{type:"primary",htmlType:"submit",children:"Guardar"})})]})})]})},ge=({quoter:o,loading:i,customers:y,onSubmit:j,onDownloadInvoice:z,onAproveQuoter:T})=>{var $;const b=c.useRef(null),[x,k]=c.useState([]),[l,S]=c.useState([]),[f,P]=c.useState([]),[w,G]=c.useState({USD:[],GTQ:[],all:[]}),[u,M]=c.useState([]),Q=a=>{var _;const[n,m]=Object.entries(a)[0];if(n==="id_subasta"){const d=w.all.filter(t=>{var s;return((s=t.subasta)==null?void 0:s.id_subasta)===m&&t.estado});d&&G({...w,USD:d}),(_=b.current)==null||_.setFieldValue("id_grua_usd",void 0)}E()},E=()=>{var n;const a=(n=b.current)==null?void 0:n.getFieldsValue();if(a&&a.id_cliente){let m=[...u];const _=y.find(t=>t.id_cliente===a.id_cliente),d=x.find(t=>t.id_puerto===a.id_puerto);if(d){const t=u.findIndex(r=>r.nombre===I.PORT_DOCUMENT_OR_EXP);if(t>-1){const r=u[t];r.valor=C(d.costo_aduanal)}else m.push({nombre:I.PORT_DOCUMENT_OR_EXP,moneda:D.USD,valor:C(d.costo_aduanal)});const s=l.find(r=>r.id_tipo_vehiculo===a.id_tipo_vehiculo);if(s){const r=u.findIndex(q=>q.nombre===I.PORT_SHIPPING),p=Number(d.costo_embarque)+Number(d.costo_embarque)*(Number(s.porcentaje_costo)/100);if(r>-1){const q=u[r];q.valor=C(p)}else m.push({nombre:I.PORT_SHIPPING,moneda:D.USD,valor:C(p)})}}if(_){if(a.id_grua_usd){const t=w.USD.find(s=>s.id_grua===a.id_grua_usd);if(t&&t.costo>0){const s=Number(t.costo)+Number(t.costo)*(Number(_.porcentaje_costo)/100),r=u.findIndex(p=>p.nombre===I.USD);if(r>-1){const p=u[r];p.valor=C(s)}else m.push({nombre:I.USD,moneda:t.moneda,valor:C(s)})}}else m=m.filter(t=>t.nombre!==I.USD);if(a.id_grua_gt){const t=w.GTQ.find(s=>s.id_grua===a.id_grua_gt);if(t&&t.costo>0){const s=Number(t.costo)+Number(t.costo)*(Number(_.porcentaje_costo)/100),r=u.findIndex(p=>p.nombre===I.GTQ);if(r>-1){const p=u[r];p.valor=C(s)}else m.push({nombre:I.GTQ,moneda:t.moneda,valor:C(s)})}}else m=m.filter(t=>t.nombre!==I.GTQ)}M(m)}};return c.useEffect(()=>{o.detalles&&M(o.detalles.map(a=>({...a,id:Math.random().toString()}))),le().then(a=>k(a==null?void 0:a.filter(n=>n.estado))).catch(a=>N.error(`Error http get ports: ${a.message}}`)),ie().then(a=>S(a==null?void 0:a.filter(n=>n.estado))).catch(a=>N.error(`Error http get type of vehicles: ${a.message}}`)),oe().then(a=>P(a==null?void 0:a.filter(n=>n.estado))).catch(a=>N.error(`Error http get autions: ${a.message}}`)),re().then(a=>{const n=a==null?void 0:a.filter(d=>d.estado),m=n==null?void 0:n.filter(d=>d.moneda===D.GTQ),_=n==null?void 0:n.filter(d=>{var t;return d.moneda===D.USD&&((t=d.subasta)==null?void 0:t.id_subasta)===o.id_subasta});G({...w,GTQ:m,all:n,USD:_})}).catch(a=>N.error(`Error http get cranes: ${a.message}}`))},[]),e.jsx(e.Fragment,{children:e.jsxs(h,{ref:b,initialValues:o.id_cotizacion===0?{}:o,layout:"vertical",onFinish:a=>j(a,u),onValuesChange:Q,children:[e.jsx("div",{className:"vhm-75 overflow-y",children:e.jsxs("div",{className:"flex flex-md-column justify-between",children:[e.jsxs("div",{className:"flex-1 p-3",children:[e.jsx(A,{orientation:"left",children:"Información del Cliente/Puerto"}),e.jsx(h.Item,{label:"Cliente",name:"id_cliente",rules:[{required:!0,message:"El campo es obligatorio"}],children:e.jsx(O,{className:"w-100",placeholder:"Selecciones una opción",options:y.map(a=>({label:a.cliente,value:a.id_cliente}))})}),e.jsx(h.Item,{label:"Puerto",name:"id_puerto",rules:[{required:!0,message:"El campo es obligatorio"}],children:e.jsx(O,{className:"w-100",placeholder:"Selecciones una opción",options:x.map(a=>({label:a.puerto,value:a.id_puerto}))})}),e.jsx(A,{orientation:"left",children:"Información del vehículo"}),e.jsxs("div",{className:"flex flex-md-column gap-3 justify-between item-end",children:[e.jsx(h.Item,{label:"Tipo de Vehículo",name:"id_tipo_vehiculo",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(O,{className:"w-100",placeholder:"Selecciones una opción",options:l.map(a=>({label:a.tipo_vehiculo,value:a.id_tipo_vehiculo}))})}),e.jsx(h.Item,{label:"Año",name:"anio",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(U,{placeholder:"Ingrese un año"})})]}),e.jsxs("div",{className:"flex flex-md-column gap-3 justify-between item-end",children:[e.jsx(h.Item,{label:"Marca",name:"marca",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(U,{placeholder:"Ingrese una Marca"})}),e.jsx(h.Item,{label:"Modelo",name:"modelo",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(U,{placeholder:"Ingrese un Modelo"})})]}),e.jsxs("div",{className:"flex flex-md-column gap-3 justify-between item-end",children:[e.jsx(h.Item,{label:"No. Lote",name:"lote",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(U,{placeholder:"Ingrese una Serie"})}),e.jsx(h.Item,{label:"VIN",name:"vin",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(U,{placeholder:"Ingrese un VIN"})})]})]}),e.jsxs("div",{className:"flex-1 p-3",children:[e.jsx(A,{orientation:"left",children:"Tramites EE. UU"}),e.jsx(h.Item,{label:"Subasta (optional)",name:"id_subasta",children:e.jsx(O,{allowClear:!0,className:"w-100",placeholder:"Selecciones una opción",options:f.map(a=>({label:a.subasta,value:a.id_subasta}))})}),e.jsx(h.Item,{label:"Grua (optional)",name:"id_grua_usd",children:e.jsx(O,{allowClear:!0,className:"w-100",placeholder:"Selecciones una opción",options:($=w.USD)==null?void 0:$.map(a=>({label:a.grua,value:a.id_grua}))})}),e.jsx(A,{orientation:"left",children:"Tramites GT"}),e.jsx(h.Item,{label:"Grua (optional)",name:"id_grua_gt",children:e.jsx(O,{allowClear:!0,className:"w-100",placeholder:"Selecciones una opción",options:w.GTQ.map(a=>({label:a.grua,value:a.id_grua}))})}),e.jsx(fe,{details:u,onSubmit:a=>M(a),aprobado:o.aprobada})]})]})}),e.jsxs("div",{className:"flex flex-row justify-end gap-2",children:[e.jsx(g,{type:"link",htmlType:"button",loading:i,disabled:i||o.id_cotizacion===0,icon:e.jsx(v.Download,{}),onClick:()=>z(o),children:"Descargar"}),e.jsx(g,{type:"dashed",htmlType:"button",loading:i,disabled:i||o.id_cotizacion===0,icon:e.jsx(v.EMail,{}),children:"Enviar Correo"}),!o.aprobada&&e.jsx(g,{type:"primary",ghost:!0,htmlType:"button",loading:i,disabled:i||o.id_cotizacion===0,icon:e.jsx(v.Done,{}),onClick:()=>T(o),children:"Aprobar"}),e.jsx(g,{type:"primary",htmlType:"submit",icon:e.jsx(v.Save,{}),loading:i,disabled:i||o.aprobada,children:"Guardar"})]})]})})},Qe=()=>{const o=Y(t=>t.device),i=Y(t=>t.session),y=J(),[j,z]=c.useState([]),[T,b]=c.useState(K),[x,k]=c.useState({data:!1,services:!1}),[l,S]=c.useState({form:!1,preview:!1}),[f,P]=c.useState({pagination:{current:1,pageSize:250}}),[w,G]=c.useState(""),[u,M]=c.useState([]),Q=(t,s=!0)=>S({[t]:s}),E=(t,s)=>k({...x,[t]:s}),$=t=>{me(t).then(s=>{b(X(s)),Q("form")}).catch(s=>N.error(`Error http get quoters: ${s.message}`))},a=async(t,s)=>{try{E("services",!0);let r;const p={...T,...t,detalles:s};T.id_cotizacion===0?r=await pe({...p,id_vendedor:i.id_sesion}):r=await W(p),r.message?N.warning(r.message):(_(),Q("form",!1))}catch(r){N.error(`Error add or edit ouoter: ${r.message}`)}finally{E("services",!1)}},n=async t=>{E("services",!0),he(t.id_cotizacion).then(s=>{var r;return ue(s,`${((r=t.cliente)==null?void 0:r.cliente)??"cotizacion"}-invoice.zip`)}).catch(s=>N.error(`Error http download invoice: ${s.message}`)).finally(()=>E("services",!1))},m=async t=>{L.confirm({title:"¿Estás seguro de aprobar esta cotización?",content:"Esta acción no se puede deshacer",okText:"Si",cancelText:"No",onOk:()=>{E("services",!0),W(X({...t,aprobada:!0})).then(s=>{N[s.error?"warning":"success"](s.message),s.error||(_(),Q("form",!1))}).catch(s=>N.error(`Error http approve quoter: ${s.message}`)).finally(()=>E("services",!1))}})},_=()=>{var t,s;E("data",!0),xe({...f,current:(t=f.pagination)==null?void 0:t.current,pageSize:(s=f.pagination)==null?void 0:s.pageSize,filter:w,sortOrder:f.sortOrder==="descend"?"DESC":"ASC"}).then(r=>{z(r.data),P({...f,pagination:{...f.pagination,total:r.total}})}).catch(r=>N.error(`Error http get quoters: ${r.message}`)).finally(()=>E("data",!1))},d=(t,s,r)=>{var p;P({pagination:t,filters:s,sortOrder:Array.isArray(r)?void 0:r.order,sortField:Array.isArray(r)?void 0:r.field}),t.pageSize!==((p=f.pagination)==null?void 0:p.pageSize)&&z([])};return c.useEffect(()=>{se().then(t=>M(t==null?void 0:t.filter(s=>s.estado))).catch(t=>N.error(`Error http get customers: ${t.message}}`))},[]),c.useEffect(()=>{_()},[JSON.stringify(f),w]),e.jsxs("div",{className:"h-100 flex flex-column p-3",children:[e.jsxs("div",{className:"flex flex-md-column gap-3 justify-between items-end mb-3",children:[e.jsxs("div",{className:"flex flex-column w-md-100",children:[e.jsx("label",{htmlFor:"cliente",children:"Cliente"}),e.jsx(O,{placeholder:"Selecciones una opción",options:u.filter(t=>t.estado).map(t=>({label:t.cliente,value:t.id_cliente})),onChange:t=>G(t),style:{minWidth:200},allowClear:!0})]}),e.jsxs("div",{className:"flex flex-row gap-2 items-center w-md-100",children:[e.jsx(V,{title:"Recargar",children:e.jsx(g,{type:"text",htmlType:"button",icon:e.jsx(v.Reload,{}),onClick:()=>_()})}),e.jsx(te,{onSearch:t=>G(t),onReset:()=>G("")})]}),e.jsx(g,{type:"primary",htmlType:"button",className:"w-md-100",onClick:()=>{b(K),Q("form")},children:"Agregar"})]}),o?e.jsx(ne,{dataSource:j,loading:x.data,renderItem:t=>{var s,r;return e.jsxs("div",{className:"item-list",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("strong",{children:"Cliente: "})," ",(s=t.cliente)==null?void 0:s.cliente]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("strong",{children:"Vendedor: "})," ",(r=t.vendedor)==null?void 0:r.nombre]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Estado: "})," ",t.estado?"Activo":"Inactivo"]}),e.jsx(g,{type:"link",danger:!0,htmlType:"button",icon:e.jsx(v.Edit,{}),onClick:()=>$(t.id_cotizacion),children:"Editar"})]})]},t.id_cotizacion)}}):e.jsx(ce,{size:"small",rowClassName:(t,s)=>s%2===0?"table-row-light":"table-row-dark",pagination:{position:["none","bottomRight"],...f.pagination,showSizeChanger:!0,pageSizeOptions:[50,100,250,500]},onChange:d,className:"table",loading:x.data,showSorterTooltip:!1,rowKey:"id_cotizacion",dataSource:j,columns:[{title:"No",dataIndex:"id_cotizacion",sorter:!0},{title:"Fecha",dataIndex:"fecha_creacion",ellipsis:!0,sorter:!0,render:t=>e.jsx("span",{children:ae(t,"DD/MM/YYYY")})},{title:"Vendedor",dataIndex:"vendedor",ellipsis:!0,sorter:!0,render:t=>e.jsx("span",{children:t.nombre})},{title:"Cliente",dataIndex:"cliente",ellipsis:!0,sorter:!0,render:t=>e.jsx("span",{children:t.cliente})},{title:"Marca",dataIndex:"marca",ellipsis:!0},{title:"Modelo",dataIndex:"modelo",ellipsis:!0},{title:"Aprobada",dataIndex:"aprobada",sorter:!0,align:"center",render:t=>e.jsx("span",{className:t?"text-success":"text-danger",children:e.jsx(ee,{color:t?"success":"error",children:t?"Sí":"No"})})},{title:"Opciones",dataIndex:"operacion",width:80,render:(t,s)=>e.jsxs("div",{className:"flex flex-row gap-1",children:[e.jsx(V,{title:"Editar",children:e.jsx(g,{style:{width:40},icon:e.jsx(v.Edit,{}),type:"text",size:"small",onClick:()=>$(s.id_cotizacion)})}),e.jsx(V,{title:"Descargar",children:e.jsx(g,{style:{width:40},icon:e.jsx(v.Download,{}),type:"text",size:"small",onClick:()=>n(s),disabled:x.services})}),!s.aprobada&&e.jsx(V,{title:"Aprobar",children:e.jsx(g,{style:{width:40},icon:e.jsx(v.Done,{}),type:"text",size:"small",onClick:()=>m(s),disabled:x.services})}),s.aprobada&&e.jsx(V,{title:"Ir a Vehiculos",children:e.jsx(g,{style:{width:40},icon:e.jsx(v.Workspace,{}),type:"text",size:"small",onClick:()=>y(`/${H.PRIVATE}/${H.VEHICLES}/${s.lote}`),disabled:x.services})})]})}]}),e.jsx(L,{open:l.form,title:e.jsxs("h3",{children:[T.id_cotizacion>0?"Editar":"Agregar"," Cotización"]}),footer:null,onCancel:()=>Q("form",!1),centered:!0,destroyOnClose:!0,width:1200,children:e.jsx(ge,{quoter:T,loading:x.services,customers:u,onSubmit:a,onDownloadInvoice:n,onAproveQuoter:m})})]})};export{Qe as Quoter};
