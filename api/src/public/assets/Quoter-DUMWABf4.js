import{r as c,j as e,y as Y,v as B,a as J,b as H}from"./index-DeRs25tb.js";import{B as g,I as v,T as V}from"./Icon-ZCyfFCep.js";import{E as Z,D as $,K as C,a as K}from"./index-jHC0o-m8.js";import{S as ee}from"./Search-DWezstAv.js";import{c as N,g as te}from"./format.utility-DkVYUxV5.js";import{d as ae}from"./fuctions.utility-D0ENTGxM.js";import{a as se}from"./customer.service-C0Zt9a2E.js";import{h as F,s as S}from"./method-http.utility-CuofCWHh.js";import{M as E}from"./Utilityes.d-EXBqBskY.js";import{h as oe}from"./aution.service-C7b7q65Q.js";import{h as re}from"./crane.service-jpIyjl31.js";import{h as ie}from"./port.service-ClIa13Yh.js";import{h as le}from"./type-vehicle.service-DgFWB7sl.js";import{M as L}from"./index-CWRTqrJg.js";import{F as h}from"./index-C8MC8u8w.js";import{I as M}from"./index-gyB3Elxo.js";import{S as Q,F as ne}from"./Table-B2h2cI4i.js";import{T as ce}from"./index-CT66_cbr.js";import{L as de}from"./index-JgT2oeId.js";import{T as ue}from"./index-DNoYEB46.js";import"./Private-Bb13mkBg.js";import"./row-Dx3yH235.js";const q="/quoter",me=async o=>await F({path:`${q}/${o}`,method:"GET"}),pe=async o=>await F({path:q,method:"POST",data:o}),W=async o=>await F({path:`${q}/${o.id_cotizacion}`,method:"PUT",data:o}),he=async o=>await F({path:`${q}/invoice/${o}`,method:"GET",responseType:"blob"}),xe=async o=>await F({path:`${q}/pagination`,method:"POST",data:o}),X=o=>{var n,T,D,z,w,j,x;return{...o,id_cliente:(n=o.cliente)==null?void 0:n.id_cliente,id_vendedor:(T=o.vendedor)==null?void 0:T.id_usuario,id_tipo_vehiculo:(D=o.tipo_veniculo)==null?void 0:D.id_tipo_vehiculo,id_puerto:(z=o.puerto)==null?void 0:z.id_puerto,id_subasta:(w=o.subasta)==null?void 0:w.id_subasta,id_grua_usd:(j=o.grua_usd)==null?void 0:j.id_grua,id_grua_gt:(x=o.grua_gt)==null?void 0:x.id_g}},fe=({aprobado:o,details:n,onSubmit:T})=>{const[D,z]=c.useState(Z),[w,j]=c.useState(!1),x=async i=>{const _=[...n];_.push({...i,valor:N(i.valor??"")}),T(_),j(!1)},P=i=>e.jsx(e.Fragment,{children:i.map((_,f)=>e.jsxs("div",{className:"flex flex-row justify-between gap-3 items-center",children:[e.jsxs("strong",{className:"flex-1",children:[_.nombre,": "]}),e.jsx("span",{children:_.moneda}),e.jsx("span",{children:N(_.valor??0)}),e.jsxs("div",{children:[e.jsx(g,{type:"link",htmlType:"button",size:"small",icon:e.jsx(v.Edit,{}),disabled:o,onClick:()=>{z({..._,index:f}),j(!0)}}),e.jsx(g,{danger:!0,type:"link",size:"small",htmlType:"button",icon:e.jsx(v.Trash,{}),disabled:o,onClick:()=>{const k=n.filter(G=>G.moneda!==_.moneda),y=i.filter((G,u)=>u!==f);T([...k,...y])}})]})]},f))});return e.jsxs(e.Fragment,{children:[n.some(i=>i.moneda===E.USD)&&e.jsx($,{orientation:"left",children:"Costos USD"}),P(n.filter(i=>i.moneda===E.USD)),n.some(i=>i.moneda===E.GTQ)&&e.jsx($,{orientation:"left",children:"Costos GTQ"}),P(n.filter(i=>i.moneda===E.GTQ)),e.jsx("div",{className:"text-right mt-3",children:e.jsx(g,{type:"primary",style:{color:Y.secondary,borderColor:Y.secondary},ghost:!0,size:"small",htmlType:"button",icon:e.jsx(v.Plus,{}),onClick:()=>j(!0),children:"Agregar"})}),e.jsx(L,{open:w,onCancel:()=>j(!1),footer:null,title:"Editar",destroyOnClose:!0,children:e.jsxs(h,{layout:"vertical",initialValues:D,onFinish:x,children:[e.jsx(h.Item,{label:"Titulo",name:"nombre",rules:[{required:!0,message:"El campo es requerido"}],children:e.jsx(M,{placeholder:"Ingrese un titulo"})}),e.jsx(h.Item,{label:"Moneda",name:"moneda",rules:[{required:!0,message:"El campo es requerido"}],children:e.jsx(Q,{allowClear:!0,className:"w-100",placeholder:"Selecciones una opción",options:Object.keys(E).map(i=>({label:i,value:E[i]}))})}),e.jsx(h.Item,{label:"Valor",name:"valor",rules:[{required:!0,message:"El campo es requerido"}],children:e.jsx(ce,{placeholder:"Ingrese un valor",className:"w-100",formatter:i=>N(i??"")})}),e.jsx("div",{className:"text-right mt-3",children:e.jsx(g,{type:"primary",htmlType:"submit",children:"Guardar"})})]})})]})},ge=({quoter:o,loading:n,customers:T,onSubmit:D,onDownloadInvoice:z,onAproveQuoter:w})=>{var U;const j=c.useRef(null),[x,P]=c.useState([]),[i,_]=c.useState([]),[f,k]=c.useState([]),[y,G]=c.useState({USD:[],GTQ:[],all:[]}),[u,A]=c.useState([]),O=a=>{var b;const[l,m]=Object.entries(a)[0];if(l==="id_subasta"){const d=y.all.filter(t=>{var s;return((s=t.subasta)==null?void 0:s.id_subasta)===m&&t.estado});d&&G({...y,USD:d}),(b=j.current)==null||b.setFieldValue("id_grua_usd",void 0)}I()},I=()=>{var l;const a=(l=j.current)==null?void 0:l.getFieldsValue();if(a&&a.id_cliente){let m=[...u];const b=T.find(t=>t.id_cliente===a.id_cliente),d=x.find(t=>t.id_puerto===a.id_puerto);if(d){const t=u.findIndex(r=>r.nombre===C.PORT_DOCUMENT_OR_EXP);if(t>-1){const r=u[t];r.valor=N(d.costo_aduanal)}else m.push({nombre:C.PORT_DOCUMENT_OR_EXP,moneda:E.USD,valor:N(d.costo_aduanal)});const s=i.find(r=>r.id_tipo_vehiculo===a.id_tipo_vehiculo);if(s){const r=u.findIndex(R=>R.nombre===C.PORT_SHIPPING),p=Number(d.costo_embarque)+Number(d.costo_embarque)*(Number(s.porcentaje_costo)/100);if(r>-1){const R=u[r];R.valor=N(p)}else m.push({nombre:C.PORT_SHIPPING,moneda:E.USD,valor:N(p)})}}if(b){if(a.id_grua_usd){const t=y.USD.find(s=>s.id_grua===a.id_grua_usd);if(t&&t.costo>0){const s=Number(t.costo)+Number(t.costo)*(Number(b.porcentaje_costo)/100),r=u.findIndex(p=>p.nombre===C.USD);if(r>-1){const p=u[r];p.valor=N(s)}else m.push({nombre:C.USD,moneda:t.moneda,valor:N(s)})}}else m=m.filter(t=>t.nombre!==C.USD);if(a.id_grua_gt){const t=y.GTQ.find(s=>s.id_grua===a.id_grua_gt);if(t&&t.costo>0){const s=Number(t.costo)+Number(t.costo)*(Number(b.porcentaje_costo)/100),r=u.findIndex(p=>p.nombre===C.GTQ);if(r>-1){const p=u[r];p.valor=N(s)}else m.push({nombre:C.GTQ,moneda:t.moneda,valor:N(s)})}}else m=m.filter(t=>t.nombre!==C.GTQ)}A(m)}};return c.useEffect(()=>{o.detalles&&A(o.detalles.map(a=>({...a,id:Math.random().toString()}))),ie().then(a=>P(a==null?void 0:a.filter(l=>l.estado))).catch(a=>S.error(`Error http get ports: ${a.message}}`)),le().then(a=>_(a==null?void 0:a.filter(l=>l.estado))).catch(a=>S.error(`Error http get type of vehicles: ${a.message}}`)),oe().then(a=>k(a==null?void 0:a.filter(l=>l.estado))).catch(a=>S.error(`Error http get autions: ${a.message}}`)),re().then(a=>{const l=a==null?void 0:a.filter(d=>d.estado),m=l==null?void 0:l.filter(d=>d.moneda===E.GTQ),b=l==null?void 0:l.filter(d=>{var t;return d.moneda===E.USD&&((t=d.subasta)==null?void 0:t.id_subasta)===o.id_subasta});G({...y,GTQ:m,all:l,USD:b})}).catch(a=>S.error(`Error http get cranes: ${a.message}}`))},[]),e.jsx(e.Fragment,{children:e.jsxs(h,{ref:j,initialValues:o.id_cotizacion===0?{}:o,layout:"vertical",onFinish:a=>D(a,u),onValuesChange:O,children:[e.jsx("div",{className:"vhm-75 overflow-y",children:e.jsxs("div",{className:"flex flex-md-column justify-between",children:[e.jsxs("div",{className:"flex-1 p-3",children:[e.jsx($,{orientation:"left",children:"Información del Cliente/Puerto"}),e.jsx(h.Item,{label:"Cliente",name:"id_cliente",rules:[{required:!0,message:"El campo es obligatorio"}],children:e.jsx(Q,{className:"w-100",placeholder:"Selecciones una opción",options:T.map(a=>({label:a.cliente,value:a.id_cliente}))})}),e.jsx(h.Item,{label:"Puerto",name:"id_puerto",rules:[{required:!0,message:"El campo es obligatorio"}],children:e.jsx(Q,{className:"w-100",placeholder:"Selecciones una opción",options:x.map(a=>({label:a.puerto,value:a.id_puerto}))})}),e.jsx($,{orientation:"left",children:"Información del vehículo"}),e.jsxs("div",{className:"flex flex-md-column gap-3 justify-between item-end",children:[e.jsx(h.Item,{label:"Tipo de Vehículo",name:"id_tipo_vehiculo",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(Q,{className:"w-100",placeholder:"Selecciones una opción",options:i.map(a=>({label:a.tipo_vehiculo,value:a.id_tipo_vehiculo}))})}),e.jsx(h.Item,{label:"Año",name:"anio",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(M,{placeholder:"Ingrese un año"})})]}),e.jsxs("div",{className:"flex flex-md-column gap-3 justify-between item-end",children:[e.jsx(h.Item,{label:"Marca",name:"marca",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(M,{placeholder:"Ingrese una Marca"})}),e.jsx(h.Item,{label:"Modelo",name:"modelo",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(M,{placeholder:"Ingrese un Modelo"})})]}),e.jsxs("div",{className:"flex flex-md-column gap-3 justify-between item-end",children:[e.jsx(h.Item,{label:"No. Lote",name:"lote",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(M,{placeholder:"Ingrese una Serie"})}),e.jsx(h.Item,{label:"VIN",name:"vin",rules:[{required:!0,message:"El campo es requerido"}],className:"w-100",children:e.jsx(M,{placeholder:"Ingrese un VIN"})})]})]}),e.jsxs("div",{className:"flex-1 p-3",children:[e.jsx($,{orientation:"left",children:"Tramites EE. UU"}),e.jsx(h.Item,{label:"Subasta (optional)",name:"id_subasta",children:e.jsx(Q,{allowClear:!0,className:"w-100",placeholder:"Selecciones una opción",options:f.map(a=>({label:a.subasta,value:a.id_subasta}))})}),e.jsx(h.Item,{label:"Grua (optional)",name:"id_grua_usd",children:e.jsx(Q,{allowClear:!0,className:"w-100",placeholder:"Selecciones una opción",options:(U=y.USD)==null?void 0:U.map(a=>({label:a.grua,value:a.id_grua}))})}),e.jsx($,{orientation:"left",children:"Tramites GT"}),e.jsx(h.Item,{label:"Grua (optional)",name:"id_grua_gt",children:e.jsx(Q,{allowClear:!0,className:"w-100",placeholder:"Selecciones una opción",options:y.GTQ.map(a=>({label:a.grua,value:a.id_grua}))})}),e.jsx(fe,{details:u,onSubmit:a=>A(a),aprobado:o.aprobada})]})]})}),e.jsxs("div",{className:"flex flex-row justify-end gap-2",children:[e.jsx(g,{type:"link",htmlType:"button",loading:n,disabled:n||o.id_cotizacion===0,icon:e.jsx(v.Download,{}),onClick:()=>z(o),children:"Descargar"}),e.jsx(g,{type:"dashed",htmlType:"button",loading:n,disabled:n||o.id_cotizacion===0,icon:e.jsx(v.EMail,{}),children:"Enviar Correo"}),!o.aprobada&&e.jsx(g,{type:"primary",ghost:!0,htmlType:"button",loading:n,disabled:n||o.id_cotizacion===0,icon:e.jsx(v.Done,{}),onClick:()=>w(o),children:"Aprobar"}),e.jsx(g,{type:"primary",htmlType:"submit",icon:e.jsx(v.Save,{}),loading:n,disabled:n||o.aprobada,children:"Guardar"})]})]})})},Ue=()=>{const o=B(t=>t.device),n=B(t=>t.session),T=J(),[D,z]=c.useState([]),[w,j]=c.useState(K),[x,P]=c.useState({data:!1,services:!1}),[i,_]=c.useState({form:!1,preview:!1}),[f,k]=c.useState({pagination:{current:1,pageSize:250}}),[y,G]=c.useState(""),[u,A]=c.useState([]),O=(t,s=!0)=>_({[t]:s}),I=(t,s)=>P({...x,[t]:s}),U=t=>{me(t).then(s=>{j(X(s)),O("form")}).catch(s=>S.error(`Error http get quoters: ${s.message}`))},a=async(t,s)=>{try{I("services",!0);let r;const p={...w,...t,detalles:s};w.id_cotizacion===0?r=await pe({...p,id_vendedor:n.id_sesion}):r=await W(p),r.message?S.warning(r.message):(b(),O("form",!1))}catch(r){S.error(`Error add or edit ouoter: ${r.message}`)}finally{I("services",!1)}},l=async t=>{I("services",!0),he(t.id_cotizacion).then(s=>{var r;return ae(s,`${((r=t.cliente)==null?void 0:r.cliente)??"cotizacion"}-invoice.zip`)}).catch(s=>S.error(`Error http download invoice: ${s.message}`)).finally(()=>I("services",!1))},m=async t=>{L.confirm({title:"¿Estás seguro de aprobar esta cotización?",content:"Esta acción no se puede deshacer",okText:"Si",cancelText:"No",onOk:()=>{I("services",!0),W(X({...t,aprobada:!0})).then(s=>{S[s.error?"warning":"success"](s.message),s.error||(b(),O("form",!1))}).catch(s=>S.error(`Error http approve quoter: ${s.message}`)).finally(()=>I("services",!1))}})},b=()=>{var t,s;I("data",!0),xe({...f,current:(t=f.pagination)==null?void 0:t.current,pageSize:(s=f.pagination)==null?void 0:s.pageSize,filter:y,sortOrder:f.sortOrder==="descend"?"DESC":"ASC"}).then(r=>{z(r.data),k({...f,pagination:{...f.pagination,total:r.total}})}).catch(r=>S.error(`Error http get quoters: ${r.message}`)).finally(()=>I("data",!1))},d=(t,s,r)=>{var p;k({pagination:t,filters:s,sortOrder:Array.isArray(r)?void 0:r.order,sortField:Array.isArray(r)?void 0:r.field}),t.pageSize!==((p=f.pagination)==null?void 0:p.pageSize)&&z([])};return c.useEffect(()=>{se().then(t=>A(t==null?void 0:t.filter(s=>s.estado))).catch(t=>S.error(`Error http get customers: ${t.message}}`))},[]),c.useEffect(()=>{b()},[JSON.stringify(f),y]),e.jsxs("div",{className:"h-100 flex flex-column p-3",children:[e.jsxs("div",{className:"flex flex-md-column gap-3 justify-between items-end mb-3",children:[e.jsxs("div",{className:"flex flex-column w-md-100",children:[e.jsx("label",{htmlFor:"cliente",children:"Cliente"}),e.jsx(Q,{placeholder:"Selecciones una opción",options:u.filter(t=>t.estado).map(t=>({label:t.cliente,value:t.id_cliente})),onChange:t=>G(t),style:{minWidth:200},allowClear:!0})]}),e.jsxs("div",{className:"flex flex-row gap-2 items-center w-md-100",children:[e.jsx(V,{title:"Recargar",children:e.jsx(g,{type:"text",htmlType:"button",icon:e.jsx(v.Reload,{}),onClick:()=>b()})}),e.jsx(ee,{onSearch:t=>G(t),onReset:()=>G("")})]}),e.jsx(g,{type:"primary",htmlType:"button",className:"w-md-100",onClick:()=>{j(K),O("form")},children:"Agregar"})]}),o?e.jsx(de,{dataSource:D,loading:x.data,renderItem:t=>{var s,r;return e.jsxs("div",{className:"item-list",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("strong",{children:"Cliente: "})," ",(s=t.cliente)==null?void 0:s.cliente]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("strong",{children:"Vendedor: "})," ",(r=t.vendedor)==null?void 0:r.nombre]}),e.jsxs("div",{className:"flex flex-row justify-between",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Estado: "})," ",t.estado?"Activo":"Inactivo"]}),e.jsx(g,{type:"link",danger:!0,htmlType:"button",icon:e.jsx(v.Edit,{}),onClick:()=>U(t.id_cotizacion),children:"Editar"})]})]},t.id_cotizacion)}}):e.jsx(ne,{size:"small",rowClassName:(t,s)=>s%2===0?"table-row-light":"table-row-dark",pagination:{position:["none","bottomRight"],...f.pagination,showSizeChanger:!0,pageSizeOptions:[50,100,250,500]},onChange:d,className:"table",loading:x.data,showSorterTooltip:!1,rowKey:"id_cotizacion",dataSource:D,columns:[{title:"No",dataIndex:"id_cotizacion",sorter:!0},{title:"Fecha",dataIndex:"fecha_creacion",ellipsis:!0,sorter:!0,render:t=>e.jsx("span",{children:te(t,"DD/MM/YYYY")})},{title:"Vendedor",dataIndex:"vendedor",ellipsis:!0,sorter:!0,render:t=>e.jsx("span",{children:t.nombre})},{title:"Cliente",dataIndex:"cliente",ellipsis:!0,sorter:!0,render:t=>e.jsx("span",{children:t.cliente})},{title:"Marca",dataIndex:"marca",ellipsis:!0},{title:"Modelo",dataIndex:"modelo",ellipsis:!0},{title:"Aprobada",dataIndex:"aprobada",sorter:!0,align:"center",render:t=>e.jsx("span",{className:t?"text-success":"text-danger",children:e.jsx(ue,{color:t?"success":"error",children:t?"Sí":"No"})})},{title:"Opciones",dataIndex:"operacion",width:80,render:(t,s)=>e.jsxs("div",{className:"flex flex-row gap-1",children:[e.jsx(V,{title:"Editar",children:e.jsx(g,{style:{width:40},icon:e.jsx(v.Edit,{}),type:"text",size:"small",onClick:()=>U(s.id_cotizacion)})}),e.jsx(V,{title:"Descargar",children:e.jsx(g,{style:{width:40},icon:e.jsx(v.Download,{}),type:"text",size:"small",onClick:()=>l(s),disabled:x.services})}),!s.aprobada&&e.jsx(V,{title:"Aprobar",children:e.jsx(g,{style:{width:40},icon:e.jsx(v.Done,{}),type:"text",size:"small",onClick:()=>m(s),disabled:x.services})}),s.aprobada&&e.jsx(V,{title:"Ir a Vehiculos",children:e.jsx(g,{style:{width:40},icon:e.jsx(v.Workspace,{}),type:"text",size:"small",onClick:()=>T(`/${H.PRIVATE}/${H.VEHICLES}/${s.lote}`),disabled:x.services})})]})}]}),e.jsx(L,{open:i.form,title:e.jsxs("h3",{children:[w.id_cotizacion>0?"Editar":"Agregar"," Cotización"]}),footer:null,onCancel:()=>O("form",!1),centered:!0,destroyOnClose:!0,width:1200,children:e.jsx(ge,{quoter:w,loading:x.services,customers:u,onSubmit:a,onDownloadInvoice:l,onAproveQuoter:m})})]})};export{Ue as Quoter};
